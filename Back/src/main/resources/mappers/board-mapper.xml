<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Investube.mvc.model.dao.BoardDao">

	<!-- ResultMap: 게시글 + 작성자 정보 -->
	<resultMap id="PostWithAuthor" type="com.Investube.mvc.model.dto.BoardPost">
		<id property="postId" column="post_id"/>
		<result property="userId" column="user_id"/>
		<result property="title" column="title"/>
		<result property="content" column="content"/>
		<result property="viewCount" column="view_count"/>
		<result property="commentCount" column="comment_count"/>
		<result property="createdAt" column="created_at"/>
		<result property="updatedAt" column="updated_at"/>
		<result property="authorNickname" column="author_nickname"/>
		<result property="authorProfileImage" column="author_profile_image"/>
	</resultMap>

	<!-- 게시글 목록 / 검색 (작성자 정보 포함, 페이지/정렬) -->
	<select id="getBoardList" resultMap="PostWithAuthor">
		SELECT 
			p.post_id,
			p.user_id,
			p.title,
			p.content,
			p.view_count,
			(SELECT COUNT(*) FROM board_comments c WHERE c.post_id = p.post_id) AS comment_count,
			p.created_at,
			p.updated_at,
			u.nickname AS author_nickname,
			u.profile_image AS author_profile_image
		FROM board_post p
		LEFT JOIN users u ON p.user_id = u.user_id
		<where>
			<if test="keyword != null and keyword != ''">
				(p.title LIKE CONCAT('%', #{keyword}, '%')
				OR p.content LIKE CONCAT('%', #{keyword}, '%'))
			</if>
		</where>
		<choose>
			<when test="sortBy == 'views'">
				ORDER BY p.view_count DESC, p.post_id DESC
			</when>
			<otherwise>
				ORDER BY p.post_id DESC
			</otherwise>
		</choose>
		LIMIT #{size} OFFSET #{offset}
	</select>
	
	<!-- 게시글 총 개수 -->
	<select id="getTotalCount" resultType="int">
		SELECT COUNT(*) 
		FROM board_post p
		<where>
			<if test="keyword != null and keyword != ''">
				(p.title LIKE CONCAT('%', #{keyword}, '%')
				OR p.content LIKE CONCAT('%', #{keyword}, '%'))
			</if>
		</where>
	</select>

	<!-- 게시글 상세 (작성자 정보 포함) -->
	<select id="getPostById" parameterType="int" resultMap="PostWithAuthor">
		SELECT 
			p.post_id,
			p.user_id,
			p.title,
			p.content,
			p.view_count,
			(SELECT COUNT(*) FROM board_comments c WHERE c.post_id = p.post_id) AS comment_count,
			p.created_at,
			p.updated_at,
			u.nickname AS author_nickname,
			u.profile_image AS author_profile_image
		FROM board_post p
		LEFT JOIN users u ON p.user_id = u.user_id
		WHERE p.post_id = #{postId}
	</select>
	
	<!-- 사용자별 게시글 조회 -->
	<select id="getPostsByUserId" resultMap="PostWithAuthor">
		SELECT 
			p.post_id,
			p.user_id,
			p.title,
			p.content,
			p.view_count,
			(SELECT COUNT(*) FROM board_comments c WHERE c.post_id = p.post_id) AS comment_count,
			p.created_at,
			p.updated_at,
			u.nickname AS author_nickname,
			u.profile_image AS author_profile_image
		FROM board_post p
		LEFT JOIN users u ON p.user_id = u.user_id
		WHERE p.user_id = #{userId}
		ORDER BY p.post_id DESC
		LIMIT #{size} OFFSET #{offset}
	</select>
	
	<!-- 사용자별 게시글 개수 -->
	<select id="getPostCountByUserId" parameterType="int" resultType="int">
		SELECT COUNT(*) 
		FROM board_post
		WHERE user_id = #{userId}
	</select>

	<!-- 게시글 등록 -->
	<insert id="createPost"
		parameterType="com.Investube.mvc.model.dto.BoardPost"
		useGeneratedKeys="true" keyProperty="postId">
		INSERT INTO board_post (user_id, title, content)
		VALUES (#{userId}, #{title}, #{content})
	</insert>

	<!-- 게시글 수정 -->
	<update id="updatePost"
		parameterType="com.Investube.mvc.model.dto.BoardPost">
		UPDATE board_post
		SET title = #{title},
		    content = #{content}
		WHERE post_id = #{postId}
	</update>

	<!-- 게시글 삭제 -->
	<delete id="deletePost" parameterType="int">
		DELETE FROM board_post WHERE post_id = #{postId}
	</delete>

	<!-- 게시글 조회수 증가 -->
	<update id="updateViewCount" parameterType="int">
		UPDATE board_post
		SET view_count = view_count + 1
		WHERE post_id = #{postId}
	</update>

</mapper>
