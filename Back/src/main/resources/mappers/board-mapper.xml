<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Investube.mvc.model.dao.BoardDao">

	<!-- ResultMap: 게시글 + 이미지 + 작성자 정보 -->
	<resultMap id="PostWithImages" type="com.Investube.mvc.model.dto.BoardPost">
		<id property="postId" column="post_id"/>
		<result property="userId" column="user_id"/>
		<result property="title" column="title"/>
		<result property="content" column="content"/>
		<result property="viewCount" column="view_count"/>
		<result property="createdAt" column="created_at"/>
		<result property="updatedAt" column="updated_at"/>
		<result property="authorNickname" column="author_nickname"/>
		<result property="authorProfileImage" column="author_profile_image"/>
		
		<collection property="images" ofType="com.Investube.mvc.model.dto.BoardImage">
			<id property="imageId" column="image_id"/>
			<result property="postId" column="post_id"/>
			<result property="imageUrl" column="image_url"/>
			<result property="createdAt" column="image_created_at"/>
		</collection>
	</resultMap>

	<!-- 게시글 목록 / 검색 (이미지 + 작성자 정보 포함, 페이징, 정렬) -->
	<select id="getBoardList" resultMap="PostWithImages">
		SELECT 
			p.post_id, p.user_id, p.title, p.content, p.view_count,
			p.created_at, p.updated_at,
			u.nickname AS author_nickname, u.profile_image AS author_profile_image,
			i.image_id, i.image_url, i.created_at AS image_created_at
		FROM board_post p
		LEFT JOIN users u ON p.user_id = u.user_id
		LEFT JOIN board_post_images i ON p.post_id = i.post_id
		<where>
			<if test="keyword != null and keyword != ''">
				(p.title LIKE CONCAT('%', #{keyword}, '%')
				OR p.content LIKE CONCAT('%', #{keyword}, '%'))
			</if>
		</where>
		<choose>
			<when test="sortBy == 'views'">
				ORDER BY p.view_count DESC, p.post_id DESC, i.image_id ASC
			</when>
			<otherwise>
				ORDER BY p.post_id DESC, i.image_id ASC
			</otherwise>
		</choose>
		LIMIT #{size} OFFSET #{offset}
	</select>
	
	<!-- 게시글 총 개수 -->
	<select id="getTotalCount" resultType="int">
		SELECT COUNT(*) 
		FROM board_post p
		<where>
			<if test="keyword != null and keyword != ''">
				(p.title LIKE CONCAT('%', #{keyword}, '%')
				OR p.content LIKE CONCAT('%', #{keyword}, '%'))
			</if>
		</where>
	</select>

	<!-- 게시글 상세 (이미지 + 작성자 정보 포함) -->
	<select id="getPostById" parameterType="int" resultMap="PostWithImages">
		SELECT 
			p.post_id, p.user_id, p.title, p.content, 
			p.created_at, p.updated_at,
			u.nickname AS author_nickname, u.profile_image AS author_profile_image,
			i.image_id, i.image_url, i.created_at AS image_created_at
		FROM board_post p
		LEFT JOIN users u ON p.user_id = u.user_id
		LEFT JOIN board_post_images i ON p.post_id = i.post_id
		WHERE p.post_id = #{postId}
		ORDER BY i.image_id ASC
	</select>
	
	<!-- 사용자별 게시글 조회 -->
	<select id="getPostsByUserId" resultMap="PostWithImages">
		SELECT 
			p.post_id, p.user_id, p.title, p.content, 
			p.created_at, p.updated_at,
			u.nickname AS author_nickname, u.profile_image AS author_profile_image,
			i.image_id, i.image_url, i.created_at AS image_created_at
		FROM board_post p
		LEFT JOIN users u ON p.user_id = u.user_id
		LEFT JOIN board_post_images i ON p.post_id = i.post_id
		WHERE p.user_id = #{userId}
		ORDER BY p.post_id DESC, i.image_id ASC
		LIMIT #{size} OFFSET #{offset}
	</select>
	
	<!-- 사용자별 게시글 개수 -->
	<select id="getPostCountByUserId" parameterType="int" resultType="int">
		SELECT COUNT(*) 
		FROM board_post
		WHERE user_id = #{userId}
	</select>

	<!-- 게시글 등록 -->
	<insert id="createPost"
		parameterType="com.Investube.mvc.model.dto.BoardPost"
		useGeneratedKeys="true" keyProperty="postId">
		INSERT INTO board_post (user_id, title, content)
		VALUES (#{userId}, #{title}, #{content})
	</insert>

	<!-- 게시글 수정 -->
	<update id="updatePost"
		parameterType="com.Investube.mvc.model.dto.BoardPost">
		UPDATE board_post
		SET title = #{title},
		content = #{content}
		WHERE post_id = #{postId}
	</update>

	<!-- 게시글 삭제 -->
	<delete id="deletePost" parameterType="int">
		DELETE FROM board_post WHERE post_id = #{postId}
	</delete>

	<!-- 이미지 여러개 저장 -->
	<insert id="insertImages" parameterType="java.util.List">
		INSERT INTO board_post_images (post_id, image_url)
		VALUES
		<foreach collection="list" item="img" separator=",">
			(#{img.postId}, #{img.imageUrl})
		</foreach>
	</insert>

	<!-- 게시글별 이미지 목록 조회 (파일 삭제용) -->
	<select id="getImagesByPostId" parameterType="int" resultType="com.Investube.mvc.model.dto.BoardImage">
		SELECT image_id, post_id, image_url, created_at
		FROM board_post_images
		WHERE post_id = #{postId}
	</select>

</mapper>