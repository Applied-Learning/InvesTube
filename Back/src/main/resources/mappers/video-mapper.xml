<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.Investube.mvc.model.dao.VideoDao">

	<!-- Result Map for Video -->
	<resultMap id="VideoResultMap" type="Video">
		<id property="videoId" column="video_id"/>
		<result property="userId" column="user_id"/>
		<result property="youtubeVideoId" column="youtube_video_id"/>
		<result property="title" column="title"/>
		<result property="thumbnailUrl" column="thumbnail_url"/>
		<result property="description" column="description"/>
		<result property="categoryId" column="category_id"/>
		<result property="viewCount" column="view_count"/>
		<result property="wishCount" column="wish_count"/>
		<result property="reviewCount" column="review_count"/>
		<result property="avgRating" column="avg_rating"/>
		<result property="createdAt" column="created_at"/>
		<result property="updatedAt" column="updated_at"/>
	</resultMap>

	<!-- 전체 비디오 조회 -->
	<select id="selectAll" resultMap="VideoResultMap">
		SELECT * FROM videos
		ORDER BY updated_at DESC
	</select>
	
	<!-- 조회수순 비디오 조회 -->
	<select id="selectByViews" resultMap="VideoResultMap">
		SELECT * FROM videos
		ORDER BY view_count DESC
	</select>
	
	<!-- 평점순 비디오 조회 -->
	<select id="selectByRating" resultMap="VideoResultMap">
		SELECT * FROM videos
		ORDER BY avg_rating DESC
	</select>
	
	<!-- 페이징 - 전체 비디오 조회 -->
	<select id="selectAllWithPaging" resultMap="VideoResultMap">
		SELECT * FROM videos
		ORDER BY updated_at DESC
		LIMIT #{size} OFFSET #{offset}
	</select>
	
	<!-- 페이징 - 조회수순 비디오 조회 -->
	<select id="selectByViewsWithPaging" resultMap="VideoResultMap">
		SELECT * FROM videos
		ORDER BY view_count DESC
		LIMIT #{size} OFFSET #{offset}
	</select>
	
	<!-- 페이징 - 평점순 비디오 조회 -->
	<select id="selectByRatingWithPaging" resultMap="VideoResultMap">
		SELECT * FROM videos
		ORDER BY avg_rating DESC
		LIMIT #{size} OFFSET #{offset}
	</select>
	
	<!-- 전체 비디오 개수 조회 -->
	<select id="selectTotalCount" resultType="int">
		SELECT COUNT(*) FROM videos
	</select>
	
	<!-- 비디오 ID로 조회 -->
	<select id="selectOne" parameterType="int" resultMap="VideoResultMap">
		SELECT * FROM videos
		WHERE video_id = #{videoId}
	</select>
	
	<!-- 비디오 등록 -->
	<insert id="insertVideo" parameterType="Video">
		INSERT INTO videos (user_id, youtube_video_id, title, thumbnail_url, description, category_id, view_count, created_at, updated_at)
		VALUES (#{userId}, #{youtubeVideoId}, #{title}, #{thumbnailUrl}, #{description}, #{categoryId}, 0, NOW(), NOW())
	</insert>
	
	<!-- 비디오 수정 -->
	<update id="updateVideo" parameterType="Video">
		UPDATE videos
		SET title = #{title},
		    thumbnail_url = #{thumbnailUrl},
		    description = #{description},
		    category_id = #{categoryId},
		    updated_at = NOW()
		WHERE video_id = #{videoId}
	</update>
	
	<!-- 비디오 삭제 -->
	<delete id="deleteVideo" parameterType="int">
		DELETE FROM videos
		WHERE video_id = #{videoId}
	</delete>
	
	<!-- 카테고리별 비디오 조회 -->
	<select id="selectByCategory" parameterType="int" resultMap="VideoResultMap">
		SELECT * FROM videos
		WHERE category_id = #{categoryId}
		ORDER BY updated_at DESC
	</select>
	
	<!-- 페이징 - 카테고리별 비디오 조회 -->
	<select id="selectByCategoryWithPaging" resultMap="VideoResultMap">
		SELECT * FROM videos
		WHERE category_id = #{categoryId}
		ORDER BY updated_at DESC
		LIMIT #{size} OFFSET #{offset}
	</select>
	
	<!-- 카테고리별 비디오 개수 조회 -->
	<select id="selectCountByCategory" parameterType="int" resultType="int">
		SELECT COUNT(*) FROM videos
		WHERE category_id = #{categoryId}
	</select>
	
	<!-- 키워드로 비디오 검색 -->
	<select id="searchByKeyword" parameterType="String" resultMap="VideoResultMap">
		SELECT * FROM videos
		WHERE title LIKE CONCAT('%', #{keyword}, '%')
		   OR description LIKE CONCAT('%', #{keyword}, '%')
		ORDER BY updated_at DESC
	</select>
	
	<!-- 페이징 - 키워드로 비디오 검색 -->
	<select id="searchByKeywordWithPaging" resultMap="VideoResultMap">
		SELECT * FROM videos
		WHERE title LIKE CONCAT('%', #{keyword}, '%')
		   OR description LIKE CONCAT('%', #{keyword}, '%')
		ORDER BY updated_at DESC
		LIMIT #{size} OFFSET #{offset}
	</select>
	
	<!-- 검색 결과 개수 조회 -->
	<select id="selectCountByKeyword" parameterType="String" resultType="int">
		SELECT COUNT(*) FROM videos
		WHERE title LIKE CONCAT('%', #{keyword}, '%')
		   OR description LIKE CONCAT('%', #{keyword}, '%')
	</select>
	
	<!-- 조회수 증가 -->
	<update id="updateViewCount" parameterType="int">
		UPDATE videos
		SET view_count = view_count + 1
		WHERE video_id = #{videoId}
	</update>
	
	<!-- 찜 여부 조회 -->
	<select id="selectWish" resultType="VideoWish">
		SELECT user_id as userId, video_id as videoId, created_at as createdAt
		FROM video_wish
		WHERE user_id = #{userId} AND video_id = #{videoId}
	</select>
	
	<!-- 찜 추가 -->
	<insert id="insertWish">
		INSERT INTO video_wish (user_id, video_id, created_at)
		VALUES (#{userId}, #{videoId}, NOW())
	</insert>
	
	<!-- 찜 삭제 -->
	<delete id="deleteWish">
		DELETE FROM video_wish
		WHERE user_id = #{userId} AND video_id = #{videoId}
	</delete>
	
	<!-- 찜한 영상 목록 조회 -->
	<select id="selectWishedVideos" parameterType="int" resultMap="VideoResultMap">
		SELECT v.*
		FROM videos v
		INNER JOIN video_wish vw ON v.video_id = vw.video_id
		WHERE vw.user_id = #{userId}
		ORDER BY vw.created_at DESC
	</select>
	
	<!-- 페이징 - 찜한 영상 목록 조회 -->
	<select id="selectWishedVideosWithPaging" resultMap="VideoResultMap">
		SELECT v.*
		FROM videos v
		INNER JOIN video_wish vw ON v.video_id = vw.video_id
		WHERE vw.user_id = #{userId}
		ORDER BY vw.created_at DESC
		LIMIT #{size} OFFSET #{offset}
	</select>
	
	<!-- 찜한 영상 개수 조회 -->
	<select id="selectCountWishedVideos" parameterType="int" resultType="int">
		SELECT COUNT(*) 
		FROM video_wish
		WHERE user_id = #{userId}
	</select>

</mapper>
